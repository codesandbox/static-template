<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>A Pen by Ivan</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.1.2/tailwind.min.css"
    />
    <style>
      * {
        /*font-family: 'Rubik', sans-serif;*/
        color: #333333;
        font-size: 17px;
        font-family: Comic Sans MS;
      }
      button,
      .button,
      input {
        outline: none;
        color: #000;
        border: 2px solid #b4b4b4;
        padding: 0.5rem 2rem;
        margin: 0rem 0.75rem;
        border-radius: 1rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }
      button[disabled],
      button.answered,
      input.answered,
      input:focus {
        color: #0af;
        border-color: #0af;
        background: rgba(0, 170, 255, 0.04);
      }
      .play-button {
        color: #f00;
        border-color: #f00;
      }
      main {
        padding: 0 10px;
      }
    </style>
  </head>

  <body translate="no">
    <div id="mainApp" class="h-screen">
      <!-- Content Generated by JS -->
    </div>

    <!-- React -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/17.0.2/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/17.0.2/umd/react-dom.production.min.js"></script>

    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.6.2/firebase-app.js"></script>

    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/8.6.2/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.2/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.2/firebase-storage.js"></script>

    <!-- RxJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/rxjs/7.1.0/rxjs.umd.min.js"></script>

    <script>
      // Your web app's Firebase configuration
      var firebaseConfig = {
        apiKey: "AIzaSyDBORguQ4fUIgHevka4CiC-M44DM5DoBLQ",
        authDomain: "gt-uoa.firebaseapp.com",
        projectId: "gt-uoa",
        storageBucket: "gt-uoa.appspot.com",
        messagingSenderId: "990838040454",
        appId: "1:990838040454:web:04bc62a06792b857696e07"
      };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);

      const db = firebase.firestore();
      const storage = firebase.storage();
    </script>

    <script id="rendered-js" type="text/babel">
      const iconCross = (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          height="100%"
          /*width="30.708"
          height="30.708"*/
          viewBox="0 0 30.708 30.708"
        >
          <path
            id="Icon_material-close"
            data-name="Icon material-close"
            d="M38.208,10.593,35.115,7.5,22.854,19.761,10.593,7.5,7.5,10.593,19.761,22.854,7.5,35.115l3.093,3.093L22.854,25.947,35.115,38.208l3.093-3.093L25.947,22.854Z"
            transform="translate(-7.5 -7.5)"
            fill="#707070"
          />
        </svg>
      );

      // state
      const NOT_ANSWERED_YET = -1;
      const ANSWER_INCORRECT = 0;
      const ANSWER_CORRECT = 1;

      const Challenge = (props, ref) => {
        const challenge = props.challenge;
        const [answer, setAnswer] = React.useState("");
        const [showHint, setShowHint] = React.useState(false);
        const [disabledChoice, setDisabledChoice] = React.useState([]);

        const [answerState, setAnswerState] = React.useState(NOT_ANSWERED_YET);

        // format: {choiceIndex: <int>, text: <string>}

        // challenge.metadata.type;
        // challenge.metadata.subtype;

        function checkAnswer() {
          return challenge.answer === answer;
        }

        const audioRef = React.useRef();

        //React.useEffect(() => {
        //  audioRef.current.play();
        //}, [challenge]);

        return (
          <div class="m-2">
            <div>
              <audio src={challenge.audio_url} ref={audioRef} />
              <button
                class="play-button"
                onClick={(e) => {
                  audioRef.current.play();
                }}
              >
                PLAY
              </button>
              {challenge.options.map((option, i) => (
                <button
                  disabled={answer === option}
                  class={answer === option ? "answered" : ""}
                  onClick={(e) => setAnswer(option)}
                >
                  {option}
                </button>
              ))}
              <button
                class="bg-yellow-500 text-white border-none"
                onClick={(e) => setShowHint((sh) => !sh)}
              >
                Hint
              </button>
              {answerState === NOT_ANSWERED_YET ||
              answerState === ANSWER_INCORRECT ? (
                <button
                  class="bg-blue-500 text-white border-none"
                  // disabled={!challengeRef.current.answerable()}
                  onClick={(e) => {
                    const answer_state = checkAnswer()
                      ? ANSWER_CORRECT
                      : ANSWER_INCORRECT;
                    setAnswerState(answer_state);
                    if (answer_state == ANSWER_CORRECT) props.onCorrect();
                  }}
                >
                  answer{" "}
                  {answerState === ANSWER_INCORRECT ? "(Wrong Answer. )" : null}
                </button>
              ) : answerState === ANSWER_CORRECT ? (
                "Correct Answer."
              ) : (
                ""
              )}
            </div>
          </div>
        );
      };

      const SpellingChallenge = (props, ref) => {
        const challenge = props.challenge;
        const [answer, setAnswer] = React.useState("");
        const [showHint, setShowHint] = React.useState(false);
        const [disabledChoice, setDisabledChoice] = React.useState([]);

        const [answerState, setAnswerState] = React.useState(NOT_ANSWERED_YET);

        // format: {choiceIndex: <int>, text: <string>}

        // challenge.metadata.type;
        // challenge.metadata.subtype;

        function checkAnswer() {
          return challenge.answer === answer;
        }

        const audioRef = React.useRef();

        //React.useEffect(() => {
        //  audioRef.current.play();
        //}, [challenge]);

        return (
          <div class="m-2">
            <div>
              <audio src={challenge.audio_url} ref={audioRef} />
              <button
                class="play-button"
                onClick={(e) => {
                  audioRef.current.play();
                }}
              >
                PLAY
              </button>
              <input
                onChange={(e) => {
                  setAnswer(event.target.value);
                }}
                value={answer}
                class={answer.length > 0 ? "answered" : ""}
              />
              <button
                class="bg-yellow-500 text-white border-none"
                onClick={(e) => setShowHint((sh) => !sh)}
              >
                Hint
              </button>
              {answerState === NOT_ANSWERED_YET ||
              answerState === ANSWER_INCORRECT ? (
                <button
                  class="bg-blue-500 text-white border-none"
                  // disabled={!challengeRef.current.answerable()}
                  onClick={(e) => {
                    const answer_state = checkAnswer()
                      ? ANSWER_CORRECT
                      : ANSWER_INCORRECT;
                    setAnswerState(answer_state);
                    if (answer_state == ANSWER_CORRECT) props.onCorrect();
                  }}
                >
                  answer{" "}
                  {answerState === ANSWER_INCORRECT ? "(Wrong Answer. )" : null}
                </button>
              ) : answerState === ANSWER_CORRECT ? (
                "Correct Answer."
              ) : (
                ""
              )}
            </div>
          </div>
        );
      };

      function Congratulations(props) {
        return (
          <div>
            <h2>Congratulations!</h2>
            <div>You have completed the quiz!</div>
          </div>
        );
      }

      function App() {
        const challengesSubject = new rxjs.Subject();
        const [pageNum, setPageNum] = React.useState(0);
        const [progress, setProgress] = React.useState(0);
        const [answerState, setAnswerState] = React.useState(NOT_ANSWERED_YET);

        const challengeRef = React.useRef();

        const [challenges, setChallenges] = React.useState([]);
        const [loaded, setLoaded] = React.useState(false);

        React.useEffect(() => {
          console.log(db);
          const unsubscribe = db
            .collection("problems")
            .onSnapshot((querySnapshot) => {
              return Promise.all(
                querySnapshot.docs.map((doc) =>
                  storage
                    .ref()
                    .child(doc.data().audio)
                    .getDownloadURL()
                    .then((url) => ({
                      ...doc.data(),
                      id: doc.id,
                      audio_url: (console.log(url), url)
                    }))
                )
              ).then(challengesSubject.next);
            });

          challengesSubject.subscribe(
            (challenges) => {
              setChallenges(challenges);
              setLoaded(true);
            },
            (err) => {
              console.err(err);
            },
            () => {
              console.log("complete");
            }
          );

          return () => {};
        }, []);

        return (
          <div class="flex flex-col h-screen">
            <nav class="flex m-5 p-10 items-center">
              <div class="flex-shrink px-10 h-5"></div>
              <div
                class="flex-grow ml-20"
                style={{
                  height: 20,
                  background: "#F1EEEE",
                  borderRadius: 10
                }}
              >
                <div
                  style={{
                    background: "#7AF16C",
                    height: "100%",
                    width: progress * 100 + "%",
                    borderRadius: 10,
                    transition: ".5s"
                  }}
                />
              </div>
              <div class="flex-shrink px-20 h-5">{iconCross}</div>
            </nav>

            <main class="flex-grow p-10">
              {challenges.map((challenge) =>
                challenge.type === "mc" ? (
                  <Challenge
                    ref={challengeRef}
                    challenge={challenge}
                    onCorrect={() => {
                      setProgress(
                        (progress) => progress + 1 / challenges.length
                      );
                    }}
                    onNext={() => {
                      setPageNum((pageNum) => pageNum + 1);
                    }}
                  />
                ) : challenge.type === "spelling" ? (
                  <SpellingChallenge
                    ref={challengeRef}
                    challenge={challenge}
                    onCorrect={() => {
                      setProgress(
                        (progress) => progress + 1 / challenges.length
                      );
                    }}
                    onNext={() => {
                      setPageNum((pageNum) => pageNum + 1);
                    }}
                  />
                ) : (
                  <button
                    onClick={() => {
                      setPageNum((pageNum) => pageNum + 1);
                    }}
                  >
                    Go To Next
                  </button>
                )
              )}
            </main>
          </div>
        );
      }

      ReactDOM.render(<App />, document.getElementById("mainApp"));
    </script>
  </body>
</html>
